# Redis를 이용한 쿠폰 발급 설계
## 1. 개요
기존 DB를 중심으로 처리된 쿠폰 발급의 로직을 Redis를 사용해 처리하는 로직으로 변경합니다.

## 2. Redis 활용 설계
### 2.1 쿠폰 발급 관리 설계
#### 데이터 구조
- **Key 패턴**:
    - **쿠폰 발급 수량 관리**: `coupon:count:{couponId}`
    - **발급 요청 큐**: `coupon:issue_queue`
    - **발급된 사용자 정보**: `coupon:issued_users:{couponId}`

- **자료구조**:
    - `Set`: 발급 여부 확인 및 사용자 중복 검증
    - `List`: 발급 요청 대기열

#### 주요 기능
- **발급 수량 증가 및 감소**:
    - Redis의 `INCR`과 `DECR` 명령어를 사용하여 쿠폰 발급 수량을 관리
- **발급 요청 큐 관리**:
    - Redis `List`를 활용해 발급 요청 데이터를 큐에 적재
- **사용자 중복 검증**:
    - Redis `Set`을 사용해 동일 사용자의 중복 발급을 방지

#### 구현 방법
- **쿠폰 발급 요청 처리**:
    1. Redis `Set`으로 사용자에게 이미 발급된 쿠폰이 있는지 확인
    2. 쿠폰 발급 가능 수량을 Redis `String`으로 관리 (`INCR`, `DECR` 사용)
    3. 발급 요청 데이터를 Redis `List`에 적재해 비동기 처리
- **발급 완료 여부 확인**:
    - Redis `Set`에 사용자 ID 추가 여부로 검증
- **발급 실패 처리**:
    - 발급 초과 시 Redis `INCR`와 `Set` 수정을 롤백

---

### 2.2 발급 요청 큐 설계
#### 데이터 구조
- **Key**: `coupon:issue_queue`
- **자료구조**: `List`

#### 주요 기능
- **응답 속도 향상**: 실제 DB에 저장하기 전, Redis에 대기열로 저장
- **비동기 처리**: 별도의 스케줄러가 Redis 데이터를 읽어 DB에 저장

---

### 2.3 사용자 쿠폰 중복 발급 방지 설계
#### 데이터 구조
- **Key**: `coupon:issued_users:{couponId}`
- **자료구조**: `Set`
- **구성 요소**:
    - Set의 멤버로 `userId`

#### 주요 기능
- **사용자 확인**:
    - Redis `SADD` 명령어로 사용자 중복 발급 확인
    - 사용자 추가 시 중복이면 `1`이 아닌 값을 반환

---

## 3. 주요 기능 구체화
### 발급 기능 구현 흐름
1. **요청 검증**:
    - Redis의 `Set`에서 사용자 발급 여부 검증
2. **발급 요청 처리**:
    - `INCR`로 발급 수량 증가 확인
    - 발급 가능 시, 쿠폰 발급 로직 수행
    - `List`에 발급 요청 데이터 추가
3. **실패 롤백**:
    - 할당 초과 시 Redis의 `DECR` 및 `Set` 데이터 롤백

### 발급 예외 처리 구현
- **발급량 초과**:
    - 쿠폰 수량 초과 감지 시 Redis 상태를 복원
- **동시성 처리**:
    - Redis의 원자성 명령을 이용해 Race Condition 방지 (`INCR`, `SADD` 등)
